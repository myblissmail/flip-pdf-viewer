<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>線上翻頁 PDF 閱覽器</title>
  <link href="https://cdn.jsdelivr.net/npm/lucide-static@0.308.0/font/lucide.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      background-color: #f5f5f5;
    }
    #viewer {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      gap: 10px;
      padding: 10px;
    }
    canvas {
      width: 48%;
      height: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      background: #fff;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      padding: 4px;
      background: #fff;
      border-top: 1px solid #ccc;
      font-size: 12px;
    }
    button, select, input[type="number"] {
      padding: 4px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    }
    button i {
      font-size: 16px;
    }
    input[type="file"] { display: none; }
    label[for="fileInput"] i { cursor: pointer; }
    #bookmark-list { display: none; }
    #pageIndicator {
      font-size: 12px;
      text-align: center;
      width: 100%;
    }
    @media (max-width: 768px) {
      canvas { width: 95% !important; }
    }
  </style>
</head>
<body>
  <div id="viewer">
    <canvas id="left-page"></canvas>
    <canvas id="right-page"></canvas>
  </div>
  <div id="controls">
    <label for="fileInput"><i class="lucide lucide-upload"></i></label>
    <input type="file" id="fileInput" accept="application/pdf" />
    <button onclick="goToPage(1)"><i class="lucide lucide-chevrons-left"></i></button>
    <button onclick="changePage(-2)"><i class="lucide lucide-chevron-left"></i></button>
    <button onclick="changePage(2)"><i class="lucide lucide-chevron-right"></i></button>
    <button onclick="goToEnd()"><i class="lucide lucide-chevrons-right"></i></button>
    <button onclick="toggleFullscreen()"><i class="lucide lucide-maximize"></i></button>
    <button onclick="toggleAutoFlip()"><i class="lucide lucide-play"></i></button>
    <input type="number" id="autoFlipSec" min="1" value="5" style="width: 40px;" />
    <button onclick="toggleSound()" id="btn-sound"><i class="lucide lucide-volume-2"></i></button>
    <button onclick="toggleEffect()" id="btn-effect"><i class="lucide lucide-stars"></i></button>
    <select onchange="switchLang(this.value)">
      <option value="zh">繁</option>
      <option value="en">EN</option>
    </select>
    <span id="pageIndicator"></span>
  </div>
  <audio id="flip-audio" preload="auto" src="flip.mp3"></audio>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    const leftCanvas = document.getElementById("left-page");
    const rightCanvas = document.getElementById("right-page");
    const pageIndicator = document.getElementById("pageIndicator");
    const fileInput = document.getElementById("fileInput");
    const audio = document.getElementById("flip-audio");
    let pdfDoc = null;
    let currentPage = 1;
    let autoFlipInterval = null;
    let soundEnabled = true;
    let effectEnabled = true;
    let lang = 'zh';
    let bookmarks = [];

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file && file.type === "application/pdf") {
        const reader = new FileReader();
        reader.onload = function() {
          const typedarray = new Uint8Array(this.result);
          pdfjsLib.getDocument(typedarray).promise.then((pdf) => {
            pdfDoc = pdf;
            currentPage = 1;
            renderPages();
          });
        };
        reader.readAsArrayBuffer(file);
      }
    });

    function renderPages() {
      if (!pdfDoc) return;

      const renderPage = (num, canvas) => {
        if (num > pdfDoc.numPages) {
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          return;
        }
        pdfDoc.getPage(num).then((page) => {
          const viewport = page.getViewport({ scale: 1.5 });
          const context = canvas.getContext("2d");
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          const renderContext = {
            canvasContext: context,
            viewport: viewport,
          };
          page.render(renderContext);
        });
      };

      renderPage(currentPage, leftCanvas);
      renderPage(currentPage + 1, rightCanvas);
      pageIndicator.textContent = `${currentPage}/${pdfDoc.numPages}`;
    }

    function changePage(offset) {
      if (!pdfDoc) return;
      currentPage = Math.max(1, Math.min(currentPage + offset, pdfDoc.numPages - 1));
      playFlipSound();
      renderPages();
    }

    function goToPage(page) {
      if (!pdfDoc) return;
      currentPage = Math.max(1, Math.min(page, pdfDoc.numPages));
      playFlipSound();
      renderPages();
    }

    function goToEnd() {
      if (!pdfDoc) return;
      currentPage = pdfDoc.numPages % 2 === 0 ? pdfDoc.numPages - 1 : pdfDoc.numPages - 2;
      renderPages();
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    function toggleSound() {
      soundEnabled = !soundEnabled;
      document.getElementById("btn-sound").innerHTML = soundEnabled
        ? '<i class="lucide lucide-volume-2"></i>'
        : '<i class="lucide lucide-volume-x"></i>';
    }

    function toggleEffect() {
      effectEnabled = !effectEnabled;
      document.getElementById("btn-effect").innerHTML = effectEnabled
        ? '<i class="lucide lucide-stars"></i>'
        : '<i class="lucide lucide-circle-slash"></i>';
    }

    function playFlipSound() {
      if (soundEnabled) {
        audio.currentTime = 0;
        audio.play();
      }
    }

    function toggleAutoFlip() {
      if (autoFlipInterval) {
        clearInterval(autoFlipInterval);
        autoFlipInterval = null;
      } else {
        const intervalSec = parseInt(document.getElementById("autoFlipSec").value);
        autoFlipInterval = setInterval(() => {
          if (currentPage + 2 <= pdfDoc.numPages) {
            changePage(2);
          } else {
            clearInterval(autoFlipInterval);
          }
        }, intervalSec * 1000);
      }
    }

    function switchLang(code) {
      lang = code;
      alert(`語言切換：${code}`);
    }

    // 滑鼠滾輪翻頁
    document.addEventListener("wheel", (e) => {
      if (e.deltaY < 0) changePage(-2);
      else changePage(2);
    });

    // 手勢滑動
    let touchStartX = null;
    document.addEventListener("touchstart", (e) => {
      touchStartX = e.changedTouches[0].screenX;
    });
    document.addEventListener("touchend", (e) => {
      if (!touchStartX) return;
      const deltaX = e.changedTouches[0].screenX - touchStartX;
      if (deltaX > 50) changePage(-2);
      else if (deltaX < -50) changePage(2);
      touchStartX = null;
    });

    // 書籤功能：按 B 鍵新增／Shift+B 查看
    document.addEventListener("keydown", (e) => {
      if (e.key === "b" && e.shiftKey) {
        alert("書籤頁數: " + bookmarks.join(", "));
      } else if (e.key === "b") {
        bookmarks.push(currentPage);
        alert(`書籤加入：第 ${currentPage} 頁`);
      }
    });
  </script>
</body>
</html>
