<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>線上翻頁 PDF 閱覽器</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      background-color: #f5f5f5;
    }
    #viewer {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      gap: 10px;
      padding: 10px;
      touch-action: pan-y;
    }
    canvas {
      width: 48%;
      height: auto;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      background: #fff;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      padding: 10px;
      background: #ffffff;
      border-top: 1px solid #ccc;
      position: sticky;
      bottom: 0;
      z-index: 100;
    }
    button, select, input[type="number"] {
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background-color: #ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: background-color 0.2s;
    }
    input[type="number"]#autoFlipSec {
      width: 40px;
      padding: 6px 8px;
    }
    button:hover {
      background-color: #f0f0f0;
    }
    #bookmark-list, #pdf-outline {
      max-height: 100px;
      overflow-y: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      padding: 5px;
    }
    #bookmark-list button, #pdf-outline button {
      white-space: nowrap;
    }
    #pageIndicator {
      font-size: 14px;
      margin-top: 5px;
      text-align: center;
      width: 100%;
    }
    @media (max-width: 768px) {
      #controls {
        flex-direction: column;
        align-items: center;
      }
      button, select, input[type="number"] {
        width: 90%;
        max-width: 300px;
      }
      canvas {
        width: 95% !important;
      }
    }
  </style>
</head>
<body>
  <div id="viewer">
    <canvas id="left-page"></canvas>
    <canvas id="right-page"></canvas>
  </div>
  <div id="controls">
    <input type="file" id="fileInput" accept="application/pdf" />
    <button onclick="goToPage(1)" id="btn-first">首頁</button>
    <button onclick="changePage(-2)" id="btn-prev">上一頁</button>
    <button onclick="changePage(2)" id="btn-next">下一頁</button>
    <button onclick="goToEnd()" id="btn-last">末頁</button>
    <button onclick="toggleFullscreen()" id="btn-full">全螢幕</button>
    <button onclick="toggleAutoFlip()" id="btn-auto">自動翻頁</button>
    <input type="number" id="autoFlipSec" min="1" value="5" title="翻頁秒數" />
    <button onclick="toggleSound()" id="btn-sound">音效開</button>
    <button onclick="toggleEffect()" id="btn-effect">特效開</button>
    <select onchange="switchLang(this.value)">
      <option value="zh">繁體中文</option>
      <option value="en">English</option>
    </select>
    <button onclick="addBookmark()" id="btn-bookmark">加入書籤</button>
    <div id="bookmark-list"></div>
    <div id="pdf-outline"></div>
    <span id="pageIndicator"></span>
  </div>
  <audio id="flip-audio" preload="auto" src="flip.mp3"></audio>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    let pdfDoc = null, currentPage = 1, totalPages = 0;
    let lang = 'zh';
    let autoFlip = false, autoFlipInterval = null;
    let soundEnabled = true, effectEnabled = true;
    const flipSound = document.getElementById("flip-audio");

    const fileInput = document.getElementById("fileInput");
    const leftCanvas = document.getElementById("left-page");
    const rightCanvas = document.getElementById("right-page");
    const leftCtx = leftCanvas.getContext("2d");
    const rightCtx = rightCanvas.getContext("2d");

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file || file.type !== "application/pdf") {
        alert(lang === 'zh' ? "請選擇正確的 PDF 檔案。" : "Please select a valid PDF file.");
        return;
      }
      const reader = new FileReader();
      reader.onload = function () {
        const typedArray = new Uint8Array(reader.result);
        pdfjsLib.getDocument({ data: typedArray }).promise
          .then(pdf => {
            pdfDoc = pdf;
            totalPages = pdf.numPages;
            currentPage = 1;
            renderPages();
            loadOutline();
          });
      };
      reader.readAsArrayBuffer(file);
    });

    function renderPages() {
      if (!pdfDoc) return;
      const leftPageNum = currentPage;
      const rightPageNum = currentPage + 1;

      if (leftPageNum <= totalPages) {
        pdfDoc.getPage(leftPageNum).then(page => {
          const viewport = page.getViewport({ scale: 1.5 });
          leftCanvas.height = viewport.height;
          leftCanvas.width = viewport.width;
          page.render({ canvasContext: leftCtx, viewport });
          applyEffect(leftCanvas);
        });
      }
      if (rightPageNum <= totalPages) {
        pdfDoc.getPage(rightPageNum).then(page => {
          const viewport = page.getViewport({ scale: 1.5 });
          rightCanvas.height = viewport.height;
          rightCanvas.width = viewport.width;
          page.render({ canvasContext: rightCtx, viewport });
          applyEffect(rightCanvas);
        });
      } else {
        rightCtx.clearRect(0, 0, rightCanvas.width, rightCanvas.height);
      }
      document.getElementById("pageIndicator").innerText = lang === 'zh'
        ? `第 ${currentPage}-${Math.min(currentPage + 1, totalPages)} 頁 / 共 ${totalPages} 頁`
        : `Page ${currentPage}-${Math.min(currentPage + 1, totalPages)} / ${totalPages}`;
    }

    function changePage(offset) {
      if (!pdfDoc) return;
      const newPage = currentPage + offset;
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderPages();
        playFlipSound();
      }
    }

    function goToPage(page) {
      if (!pdfDoc || page < 1 || page > totalPages) return;
      currentPage = page;
      renderPages();
      playFlipSound();
    }

    function goToEnd() {
      if (!pdfDoc) return;
      currentPage = totalPages % 2 === 0 ? totalPages - 1 : totalPages;
      renderPages();
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    }

    function toggleAutoFlip() {
      autoFlip = !autoFlip;
      document.getElementById("btn-auto").innerText = autoFlip ? (lang === 'zh' ? "停止翻頁" : "Stop") : (lang === 'zh' ? "自動翻頁" : "Auto Flip");
      if (autoFlip) {
        const interval = parseInt(document.getElementById("autoFlipSec").value) * 1000;
        autoFlipInterval = setInterval(() => {
          if (currentPage + 2 <= totalPages) changePage(2);
          else toggleAutoFlip();
        }, interval);
      } else clearInterval(autoFlipInterval);
    }

    function toggleSound() {
      soundEnabled = !soundEnabled;
      document.getElementById("btn-sound").innerText = soundEnabled ? (lang === 'zh' ? "音效開" : "Sound On") : (lang === 'zh' ? "音效關" : "Sound Off");
    }

    function toggleEffect() {
      effectEnabled = !effectEnabled;
      document.getElementById("btn-effect").innerText = effectEnabled ? (lang === 'zh' ? "特效開" : "Effect On") : (lang === 'zh' ? "特效關" : "Effect Off");
    }

    function switchLang(language) {
      lang = language;
      // 更新 UI 文案... (略)
      renderPages();
    }

    function playFlipSound() {
      if (soundEnabled) {
        flipSound.currentTime = 0;
        flipSound.play();
      }
    }

    function applyEffect(canvas) {
      if (!effectEnabled) return;
      canvas.style.transform = "rotateY(15deg)";
      setTimeout(() => canvas.style.transform = "rotateY(0deg)", 150);
    }

    function addBookmark() {
      if (!pdfDoc) return;
      const list = document.getElementById("bookmark-list");
      const btn = document.createElement("button");
      btn.innerText = lang === 'zh' ? `第 ${currentPage} 頁` : `Page ${currentPage}`;
      btn.onclick = () => goToPage(currentPage);
      list.appendChild(btn);
    }

    function loadOutline() {
      pdfDoc.getOutline().then(outline => {
        const container = document.getElementById("pdf-outline");
        container.innerHTML = "";
        if (!outline) return;
        outline.forEach(item => {
          const btn = document.createElement("button");
          btn.innerText = item.title;
          btn.onclick = () => {
            pdfDoc.getPageIndex(item.dest[0]).then(index => {
              goToPage(index + 1);
            });
          };
          container.appendChild(btn);
        });
      });
    }

    // 滑鼠滾輪翻頁
    document.getElementById("viewer").addEventListener("wheel", (e) => {
      e.preventDefault();
      if (!pdfDoc) return;
      e.deltaY > 0 ? changePage(2) : changePage(-2);
    }, { passive: false });

    // 觸控滑動翻頁
    let touchStartX = 0;
    const viewer = document.getElementById("viewer");
    viewer.addEventListener("touchstart", (e) => {
      touchStartX = e.touches[0].clientX;
    });
    viewer.addEventListener("touchend", (e) => {
      const deltaX = e.changedTouches[0].clientX - touchStartX;
      if (Math.abs(deltaX) > 50) {
        deltaX > 0 ? changePage(-2) : changePage(2);
      }
    });
  </script>
</body>
</html>
